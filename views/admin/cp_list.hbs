<head>
  <meta http-equiv="refresh" content="30">
</head>

<div style="display: flex; flex: 1;">
    <nav style="min-width: 240px; width: 240px; border-right: 1px solid #ddd;">
        {{> admin-nav }}
    </nav>
    <main style="flex-grow: 1; 0rem; display: flex; flex-direction: column; padding-top: 1rem;">
        {{!-- {{> message}} --}} 
        
        <div class="mb-4">
            <div class="d-flex justify-content-end align-items-center mb-3" style="gap: 1rem;">
                <!-- 場域總功耗設置區塊（wrap_content，水平排列） -->
                <form class="d-flex align-items-center" method="POST" action="/admin/set_site_power" style="padding:0.5rem 1rem; width:auto; display:inline-flex;">
                    <label for="maxPower" class="form-label me-2 mb-0" style="font-weight:500; white-space:nowrap;">場域總功耗上限 (kW):</label>
                    <input type="number" step="0.1" min="0" class="form-control me-2" id="maxPower" name="max_power_kw" value="{{site_settings.max_power_kw}}" style="width:100px;" placeholder="480">
                    <button type="submit" class="btn btn-primary btn-md d-flex align-items-center shadow-sm" style="border-radius: 4px; font-weight: 500; font-size: 1rem;">
                        儲存
                    </button>
                </form>
                <!-- 負載平衡開關與下拉式選單 -->
                <form class="d-flex align-items-center" method="POST" action="/admin/set_load_balance" style="width:auto; display:inline-flex;" id="loadBalanceForm">
                    <label class="form-check-label me-2" for="loadBalanceMode" style="font-weight:500;">負載平衡: </label>
                    <select class="form-select" style="width:120px; border-radius:4px;" id="loadBalanceMode" name="load_balance_mode" onchange="document.getElementById('loadBalanceForm').submit();">
                        <option value="static" {{#equal site_settings.ems_mode 'static'}}selected{{/equal}}>靜態分配</option>
                        <option value="dynamic" {{#equal site_settings.ems_mode 'dynamic'}}selected{{/equal}}>動態分配</option>
                        <option value="priority" {{#equal site_settings.ems_mode 'priority'}}selected{{/equal}}>優先分配</option>
                    </select>
                </form>
                <!-- 新增充電樁按鈕 -->
                <button type="button" class="btn btn-primary btn-md shadow-sm d-flex align-items-center me-3" style="border-radius:4px; font-weight:500; font-size:1.1rem; padding:0.5rem 1.5rem;" onclick="window.location.href='/admin/add_cp'">
                    新增充電樁
                </button>
            </div>
            <div class="p-0">
                <div class="container-fluid">
                    <div class="row g-3">
                        {{#each cp_list}}
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                            <div class="card h-100 border-3 border-primary shadow-sm rounded-4 card-charger position-relative" style="transition: box-shadow 0.2s; border-radius: 1rem;">
                                <div class="card-header d-flex align-items-center justify-content-between" style="background: #b7ca39; border-bottom: none; border-top-left-radius: .5rem; border-top-right-radius: .5rem;">
                    <div class="d-flex align-items-center">
                        <span class="bg-white text-primary d-flex align-items-center justify-content-center rounded-circle me-3" style="width:40px;height:40px;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                            <span class="material-icons" style="font-size:28px; color: #111;">ev_station</span>
                        </span>
                        <span class="fw-bold" style="font-size:1.2rem; color: #111; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:inline-block; vertical-align:bottom;">{{this.cpid}}</span>
                    </div>
                                        {{#equal this.guns_status "Available"}}
                                            <span class="chip" style="background:#43a047; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">可用</span>
                                        {{else}}
                                            {{#equal this.guns_status "Preparing"}}
                                                <span class="chip" style="background:#0288d1; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">準備中</span>
                                            {{else}}
                                                {{#equal this.guns_status "Charging"}}
                                                    <span class="chip" style="background:#1976d2; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">充電中</span>
                                                {{else}}
                                                    {{#equal this.guns_status "SuspendedEV"}}
                                                        <span class="chip" style="background:#fbc02d; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">暫停(車端)</span>
                                                    {{else}}
                                                        {{#equal this.guns_status "SuspendedEVSE"}}
                                                            <span class="chip" style="background:#fbc02d; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">暫停(樁端)</span>
                                                        {{else}}
                                                            {{#equal this.guns_status "Finishing"}}
                                                                <span class="chip" style="background:#7b1fa2; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">結束中</span>
                                                            {{else}}
                                                                {{#equal this.guns_status "Faulted"}}
                                                                    <span class="chip" style="background:#d32f2f; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">故障</span>
                                                                {{else}}
                                                                    {{#equal this.guns_status "Unavailable"}}
                                                                        <span class="chip" style="background:#d32f2f; color:#fff; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">不可用</span>
                                                                    {{else}}
                                                                        <span class="chip" style="background:#bdbdbd; color:#333; font-weight:500; font-size:1rem; padding:0.25rem 1rem; border-radius:16px;">{{this.guns_status}}</span>
                                                                    {{/equal}}
                                                                {{/equal}}
                                                            {{/equal}}
                                                        {{/equal}}
                                                    {{/equal}}
                                                {{/equal}}
                                            {{/equal}}
                                        {{/equal}}
                                </div>
                                <div class="card-body p-3 bg-light" style="border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">Connector:</span>
                                            <span class="text-dark">{{this.connector}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">樁編號:</span>
                                            <span class="text-dark">{{this.cpsn}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">狀態:</span>
                                            <span class="text-dark">{{this.guns_status}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">已充度數:</span>
                                            <span class="text-dark">{{this.guns_metervalue1}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">電流:</span>
                                            <span class="text-dark">{{this.guns_metervalue2}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">電壓:</span>
                                            <span class="text-dark">{{this.guns_metervalue3}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">功率:</span>
                                            <span class="text-dark">{{this.guns_metervalue4}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">保留:</span>
                                            <span class="text-dark">{{this.guns_metervalue5}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">回合碼:</span>
                                            <span class="text-dark">{{this.guns_metervalue6}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">描述:</span>
                                            <span class="text-dark">{{this.guns_memo1}}</span>
                                        </div>
                                        <div class="mb-1 d-flex justify-content-between align-items-center">
                                            <span class="text-secondary">最後更新:</span>
                                            <span class="text-dark">{{this.guns_memo2}}</span>
                                        </div>
                                </div>
                                <div class="card-footer bg-white d-flex justify-content-between border-0" style="border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                                    <div>
                                        <a href="/admin/start_charging/{{this.cpid}}" class="btn btn-outline-success btn-sm me-1 shadow-sm"><span class="material-icons" style="font-size:18px;vertical-align:middle;">play_arrow</span> 啟動</a>
                                        <a href="/admin/stop_charging/{{this.cpid}}" class="btn btn-outline-danger btn-sm shadow-sm"><span class="material-icons" style="font-size:18px;vertical-align:middle;">stop</span> 停止</a>
                                    </div>
                                    <div>
                                        <a href="/admin/show_current_cp/{{this.id}}" class="btn btn-outline-warning btn-sm me-1 shadow-sm"><span class="material-icons" style="font-size:18px;vertical-align:middle;">edit</span> 編輯</a>
                                        <form action="/admin/post_del_cp/{{this.id}}?_method=DELETE" method="POST" class="d-inline">
                                            <button type="submit" class="btn btn-outline-danger btn-sm shadow-sm" onclick="return confirmDelete()"><span class="material-icons" style="font-size:18px;vertical-align:middle;">delete</span> 刪除</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                </div>
            </div>
        </div>
<script language="JavaScript">

</script>
